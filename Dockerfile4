# Imagen base de PHP 8.3 con FPM y Alpine
FROM php:8.3.7-fpm-alpine

# Instalar paquetes necesarios
RUN apk add --no-cache linux-headers \
    bash git sudo openssh libxml2-dev oniguruma-dev autoconf gcc g++ make npm \
    freetype-dev libjpeg-turbo-dev libpng-dev libzip-dev ssmtp icu-dev

# Instalar extensiones PHP
RUN pecl channel-update pecl.php.net && \
    pecl install pcov swoole && \
    docker-php-ext-configure gd --with-freetype --with-jpeg && \
    docker-php-ext-install mbstring xml pcntl gd zip sockets pdo pdo_mysql bcmath soap intl && \
    docker-php-ext-enable mbstring xml gd zip pcov pcntl sockets bcmath pdo pdo_mysql soap swoole

# Instalar Composer
RUN curl -sS https://getcomposer.org/installer | php -- \
     --install-dir=/usr/local/bin --filename=composer

# Configurar RoadRunner
COPY --from=spiralscout/roadrunner:2.4.2 /usr/bin/rr /usr/bin/rr

# Establecer directorio de trabajo
WORKDIR /app

# Copiar archivos del proyecto
COPY . .

# Instalar dependencias de Composer
RUN composer install --no-interaction --prefer-dist && \
    composer require laravel/octane spiral/roadrunner

# Copiar archivo de entorno
COPY .envDev .env
RUN ls -lah public/storage

# Configurar permisos y almacenamiento
RUN mkdir -p /app/storage/logs && chmod -R 777 /app/storage

# Instalar Laravel Octane con Swoole
RUN php artisan octane:install --server="swoole"

# Exponer puerto 8000
EXPOSE 8000

# Ejecutar Laravel Octane usando la sintaxis JSON recomendada
CMD ["php", "artisan", "octane:start", "--server=swoole", "--host=0.0.0.0"]
